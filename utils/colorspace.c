#include <stdint.h>

#include "utils.h"
#include "colorspace.h"
#include "vlog.h"

VLOG_REGISTER(clr, DEBUG)

const float v2r_8bit[] = {
    0.00,   1.28,   2.56,   3.84,   5.12,   6.40,   7.68,   8.96,   10.24,
    11.52,  12.80,  14.08,  15.36,  16.64,  17.92,  19.20,  20.48,  21.76,
    23.04,  24.32,  25.60,  26.88,  28.16,  29.44,  30.72,  32.00,  33.28,
    34.56,  35.84,  37.12,  38.40,  39.68,  40.96,  42.24,  43.52,  44.80,
    46.08,  47.36,  48.64,  49.92,  51.20,  52.48,  53.76,  55.04,  56.32,
    57.60,  58.88,  60.16,  61.44,  62.72,  64.00,  65.28,  66.56,  67.84,
    69.12,  70.40,  71.68,  72.96,  74.24,  75.52,  76.80,  78.08,  79.36,
    80.64,  81.92,  83.20,  84.48,  85.76,  87.04,  88.32,  89.60,  90.88,
    92.16,  93.44,  94.72,  96.00,  97.28,  98.56,  99.84,  101.12, 102.40,
    103.68, 104.96, 106.24, 107.52, 108.80, 110.08, 111.36, 112.64, 113.92,
    115.20, 116.48, 117.76, 119.04, 120.32, 121.60, 122.88, 124.16, 125.44,
    126.72, 128.00, 129.28, 130.56, 131.84, 133.12, 134.40, 135.68, 136.96,
    138.24, 139.52, 140.80, 142.08, 143.36, 144.64, 145.92, 147.20, 148.48,
    149.76, 151.04, 152.32, 153.60, 154.88, 156.16, 157.44, 158.72, 160.00,
    161.28, 162.56, 163.84, 165.12, 166.40, 167.68, 168.96, 170.24, 171.52,
    172.80, 174.08, 175.36, 176.64, 177.92, 179.20, 180.48, 181.76, 183.04,
    184.32, 185.60, 186.88, 188.16, 189.44, 190.72, 192.00, 193.28, 194.56,
    195.84, 197.12, 198.40, 199.68, 200.96, 202.24, 203.52, 204.80, 206.08,
    207.36, 208.64, 209.92, 211.20, 212.48, 213.76, 215.04, 216.32, 217.60,
    218.88, 220.16, 221.44, 222.72, 224.00, 225.28, 226.56, 227.84, 229.12,
    230.40, 231.68, 232.96, 234.24, 235.52, 236.80, 238.08, 239.36, 240.64,
    241.92, 243.20, 244.48, 245.76, 247.04, 248.32, 249.60, 250.88, 252.16,
    253.44, 254.72, 256.00, 257.28, 258.56, 259.84, 261.12, 262.40, 263.68,
    264.96, 266.24, 267.52, 268.80, 270.08, 271.36, 272.64, 273.92, 275.20,
    276.48, 277.76, 279.04, 280.32, 281.60, 282.88, 284.16, 285.44, 286.72,
    288.00, 289.28, 290.56, 291.84, 293.12, 294.40, 295.68, 296.96, 298.24,
    299.52, 300.80, 302.08, 303.36, 304.64, 305.92, 307.20, 308.48, 309.76,
    311.04, 312.32, 313.60, 314.88, 316.16, 317.44, 318.72, 320.00, 321.28,
    322.56, 323.84, 325.12, 326.40};

const float v2g_8bit[] = {
    0.00,   -0.38,  -0.76,  -1.14,  -1.52,  -1.91,  -2.29,  -2.67,  -3.05,
    -3.43,  -3.81,  -4.19,  -4.57,  -4.95,  -5.33,  -5.71,  -6.10,  -6.48,
    -6.86,  -7.24,  -7.62,  -8.00,  -8.38,  -8.76,  -9.14,  -9.53,  -9.91,
    -10.29, -10.67, -11.05, -11.43, -11.81, -12.19, -12.57, -12.95, -13.34,
    -13.72, -14.10, -14.48, -14.86, -15.24, -15.62, -16.00, -16.38, -16.76,
    -17.14, -17.53, -17.91, -18.29, -18.67, -19.05, -19.43, -19.81, -20.19,
    -20.57, -20.96, -21.34, -21.72, -22.10, -22.48, -22.86, -23.24, -23.62,
    -24.00, -24.38, -24.77, -25.15, -25.53, -25.91, -26.29, -26.67, -27.05,
    -27.43, -27.81, -28.19, -28.57, -28.96, -29.34, -29.72, -30.10, -30.48,
    -30.86, -31.24, -31.62, -32.00, -32.38, -32.77, -33.15, -33.53, -33.91,
    -34.29, -34.67, -35.05, -35.43, -35.81, -36.20, -36.58, -36.96, -37.34,
    -37.72, -38.10, -38.48, -38.86, -39.24, -39.62, -40.01, -40.39, -40.77,
    -41.15, -41.53, -41.91, -42.29, -42.67, -43.05, -43.43, -43.81, -44.20,
    -44.58, -44.96, -45.34, -45.72, -46.10, -46.48, -46.86, -47.24, -47.62,
    -48.01, -48.39, -48.77, -49.15, -49.53, -49.91, -50.29, -50.67, -51.05,
    -51.44, -51.82, -52.20, -52.58, -52.96, -53.34, -53.72, -54.10, -54.48,
    -54.86, -55.24, -55.63, -56.01, -56.39, -56.77, -57.15, -57.53, -57.91,
    -58.29, -58.67, -59.05, -59.44, -59.82, -60.20, -60.58, -60.96, -61.34,
    -61.72, -62.10, -62.48, -62.87, -63.25, -63.63, -64.01, -64.39, -64.77,
    -65.15, -65.53, -65.91, -66.29, -66.67, -67.06, -67.44, -67.82, -68.20,
    -68.58, -68.96, -69.34, -69.72, -70.10, -70.48, -70.87, -71.25, -71.63,
    -72.01, -72.39, -72.77, -73.15, -73.53, -73.91, -74.30, -74.68, -75.06,
    -75.44, -75.82, -76.20, -76.58, -76.96, -77.34, -77.72, -78.11, -78.49,
    -78.87, -79.25, -79.63, -80.01, -80.39, -80.77, -81.15, -81.53, -81.92,
    -82.30, -82.68, -83.06, -83.44, -83.82, -84.20, -84.58, -84.96, -85.34,
    -85.72, -86.11, -86.49, -86.87, -87.25, -87.63, -88.01, -88.39, -88.77,
    -89.15, -89.53, -89.92, -90.30, -90.68, -91.06, -91.44, -91.82, -92.20,
    -92.58, -92.96, -93.34, -93.73, -94.11, -94.49, -94.87, -95.25, -95.63,
    -96.01, -96.39, -96.77, -97.16};

const float u2g_8bit[] = {
    0.00,   -0.21,  -0.43,  -0.65,  -0.86,  -1.07,  -1.29,  -1.50,  -1.72,
    -1.94,  -2.15,  -2.36,  -2.58,  -2.79,  -3.01,  -3.23,  -3.44,  -3.65,
    -3.87,  -4.08,  -4.30,  -4.51,  -4.73,  -4.95,  -5.16,  -5.38,  -5.59,
    -5.80,  -6.02,  -6.24,  -6.45,  -6.67,  -6.88,  -7.09,  -7.31,  -7.52,
    -7.74,  -7.96,  -8.17,  -8.38,  -8.60,  -8.81,  -9.03,  -9.24,  -9.46,
    -9.68,  -9.89,  -10.11, -10.32, -10.54, -10.75, -10.96, -11.18, -11.39,
    -11.61, -11.82, -12.04, -12.25, -12.47, -12.69, -12.90, -13.12, -13.33,
    -13.54, -13.76, -13.97, -14.19, -14.40, -14.62, -14.83, -15.05, -15.27,
    -15.48, -15.70, -15.91, -16.12, -16.34, -16.55, -16.77, -16.98, -17.20,
    -17.41, -17.63, -17.84, -18.06, -18.27, -18.49, -18.70, -18.92, -19.13,
    -19.35, -19.57, -19.78, -20.00, -20.21, -20.43, -20.64, -20.86, -21.07,
    -21.29, -21.50, -21.71, -21.93, -22.14, -22.36, -22.57, -22.79, -23.00,
    -23.22, -23.43, -23.65, -23.86, -24.08, -24.29, -24.51, -24.72, -24.94,
    -25.16, -25.37, -25.59, -25.80, -26.02, -26.23, -26.45, -26.66, -26.88,
    -27.09, -27.30, -27.52, -27.73, -27.95, -28.16, -28.38, -28.59, -28.81,
    -29.02, -29.24, -29.45, -29.67, -29.88, -30.10, -30.32, -30.53, -30.75,
    -30.96, -31.18, -31.39, -31.61, -31.82, -32.03, -32.25, -32.46, -32.68,
    -32.89, -33.11, -33.33, -33.54, -33.76, -33.97, -34.19, -34.40, -34.62,
    -34.83, -35.05, -35.26, -35.48, -35.69, -35.91, -36.12, -36.34, -36.55,
    -36.77, -36.98, -37.20, -37.41, -37.62, -37.84, -38.05, -38.27, -38.48,
    -38.70, -38.91, -39.13, -39.34, -39.56, -39.77, -39.99, -40.20, -40.42,
    -40.63, -40.85, -41.06, -41.28, -41.49, -41.71, -41.92, -42.14, -42.35,
    -42.57, -42.78, -43.00, -43.21, -43.43, -43.64, -43.86, -44.08, -44.29,
    -44.51, -44.72, -44.94, -45.15, -45.37, -45.58, -45.80, -46.01, -46.23,
    -46.44, -46.66, -46.87, -47.09, -47.30, -47.52, -47.73, -47.95, -48.16,
    -48.38, -48.59, -48.80, -49.02, -49.23, -49.45, -49.66, -49.88, -50.09,
    -50.31, -50.52, -50.74, -50.95, -51.17, -51.38, -51.60, -51.81, -52.03,
    -52.24, -52.46, -52.67, -52.89, -53.10, -53.32, -53.53, -53.75, -53.96,
    -54.18, -54.39, -54.61, -54.82};

const float u2b_8bit[] = {
    0.00,   2.22,   4.44,   6.65,   8.87,   11.09,  13.31,  15.53,  17.74,
    19.96,  22.18,  24.40,  26.62,  28.83,  31.05,  33.27,  35.49,  37.71,
    39.92,  42.14,  44.36,  46.58,  48.80,  51.01,  53.23,  55.45,  57.67,
    59.89,  62.10,  64.32,  66.54,  68.76,  70.98,  73.19,  75.41,  77.63,
    79.85,  82.07,  84.28,  86.50,  88.72,  90.94,  93.16,  95.37,  97.59,
    99.81,  102.03, 104.25, 106.46, 108.68, 110.90, 113.12, 115.34, 117.55,
    119.77, 121.99, 124.21, 126.43, 128.64, 130.86, 133.08, 135.30, 137.52,
    139.73, 141.95, 144.17, 146.39, 148.61, 150.82, 153.04, 155.26, 157.48,
    159.70, 161.91, 164.13, 166.35, 168.57, 170.79, 173.00, 175.22, 177.44,
    179.66, 181.88, 184.09, 186.31, 188.53, 190.75, 192.97, 195.18, 197.40,
    199.62, 201.84, 204.06, 206.27, 208.49, 210.71, 212.93, 215.15, 217.36,
    219.58, 221.80, 224.02, 226.24, 228.45, 230.67, 232.89, 235.11, 237.33,
    239.54, 241.76, 243.98, 246.20, 248.42, 250.63, 252.85, 255.07, 257.29,
    259.51, 261.72, 263.94, 266.16, 268.38, 270.60, 272.81, 275.03, 277.25,
    279.47, 281.69, 283.90, 286.12, 288.34, 290.56, 292.78, 294.99, 297.21,
    299.43, 301.65, 303.87, 306.08, 308.30, 310.52, 312.74, 314.96, 317.17,
    319.39, 321.61, 323.83, 326.05, 328.26, 330.48, 332.70, 334.92, 337.14,
    339.35, 341.57, 343.79, 346.01, 348.23, 350.44, 352.66, 354.88, 357.10,
    359.32, 361.53, 363.75, 365.97, 368.19, 370.41, 372.62, 374.84, 377.06,
    379.28, 381.50, 383.71, 385.93, 388.15, 390.37, 392.59, 394.80, 397.02,
    399.24, 401.46, 403.68, 405.89, 408.11, 410.33, 412.55, 414.77, 416.98,
    419.20, 421.42, 423.64, 425.86, 428.07, 430.29, 432.51, 434.73, 436.95,
    439.16, 441.38, 443.60, 445.82, 448.04, 450.25, 452.47, 454.69, 456.91,
    459.13, 461.34, 463.56, 465.78, 468.00, 470.22, 472.43, 474.65, 476.87,
    479.09, 481.31, 483.52, 485.74, 487.96, 490.18, 492.40, 494.61, 496.83,
    499.05, 501.27, 503.49, 505.70, 507.92, 510.14, 512.36, 514.58, 516.79,
    519.01, 521.23, 523.45, 525.67, 527.88, 530.10, 532.32, 534.54, 536.76,
    538.97, 541.19, 543.41, 545.63, 547.85, 550.06, 552.28, 554.50, 556.72,
    558.94, 561.15, 563.37, 565.59};

static void
YUV_to_BGRA32_16bit(uint8_t *ptr, int pitch, void *Y, void *U,
                    void *V, int v, int h)
{
    int16_t *sY = (int16_t *)Y;
    int16_t *sU = (int16_t *)U;
    int16_t *sV = (int16_t *)V;
    uint8_t *p = ptr;
    int16_t yy, uu, vv;

    for (int i = 0; i < 8 * v; i++) {
        for (int k = 0; k < 8 * h; k++) {
            int y, cb, cr;
            int add_r, add_g, add_b;
            int r, g, b;

            // The Y[64 * 4] store the Y componets, but not in the 16 * 16 array, just four 8 * 8 array
            yy = sY[((i / 8) * h + (k / 8)) * 64 + (i % 8) * 8 + k % 8];
            uu = sU[(i / v) * 8 + (k / h)] - 128;
            vv = sV[(i / v) * 8 + (k / h)] - 128;

            //see JFIF3
            // add_r = FIX(1.40200) * vv + ONE_HALF;
            // add_g = -FIX(0.34414) * uu - FIX(0.71414) * vv + ONE_HALF;
            // add_b = FIX(1.772) * uu + ONE_HALF;

            // y = (yy) << SCALEBITS;
            // b = (y + add_b) >> SCALEBITS;
            // g = (y + add_g) >> SCALEBITS;
            // r = (y + add_r) >> SCALEBITS;

            r = clamp(yy + 1.280 * vv, 255);
            g = clamp(yy - 0.215 * uu - 0.381 * vv, 255);
            b = clamp(yy + 2.128 * uu, 255);
            p[4 * k] = b;
            p[4 * k + 1] = g;
            p[4 * k + 2] = r;
            p[4 * k + 3] = 0xff; // alpha
        }
        p += pitch;
    }
}

static void
YUV_to_BGRA32_8bit(uint8_t *ptr, int pitch, void *Y, void *U, void *V,
                   int v, int h)
{
    uint8_t *sY = Y;
    uint8_t *sU = U;
    uint8_t *sV = V;
    uint8_t *p = ptr;
    int yy, uu, vv;
    int add_r, add_g, add_b;
    int r, g, b;

    for (int i = 0; i < 8 * v; i++) {
        for (int k = 0; k < 8 * h; k++) {

            // The Y[64 * 4] store the Y componets, but not in the 16 * 16
            // array, just four 8 * 8 array
            yy = sY[((i / 8) * h + (k / 8)) * 64 + (i % 8) * 8 + k % 8];
            uu = sU[(i / v) * 8 + (k / h)] - 128;
            vv = sV[(i / v) * 8 + (k / h)] - 128;

            // see JFIF3 page 3
            // add_r = FIX(1.40200) * vv + ONE_HALF;
            // add_g = -FIX(0.34414) * uu - FIX(0.71414) * vv + ONE_HALF;
            // add_b = FIX(1.772) * uu + ONE_HALF;

            // y = (yy) << SCALEBITS;
            // b = (y + add_b) >> SCALEBITS;
            // g = (y + add_g) >> SCALEBITS;
            // r = (y + add_r) >> SCALEBITS;

            // r = clamp(yy + 1.280 * vv, 255);
            // g = clamp(yy - 0.215 * uu - 0.381 * vv, 255);
            // b = clamp(yy + 2.128 * uu, 255);
            r = clamp(yy + v2r_8bit[vv], 255);
            g = clamp(yy + u2g_8bit[uu] + v2g_8bit[vv], 255);
            b = clamp(yy + u2b_8bit[uu], 255);
            p[4 * k] = b;
            p[4 * k + 1] = g;
            p[4 * k + 2] = r;
            p[4 * k + 3] = 0xff; // alpha
        }
        p += pitch;
    }
}

void BGR24_to_YUV420(uint8_t *ptr, int pitch, int16_t *Y, int16_t *U,
                      int16_t *V) {
    int r, g, b;
    uint8_t *p = ptr;
    uint8_t *p2 = ptr;
    for (int k = 0; k < 4; k++) {
        p = p2;
        if (k == 1) {
            p2 = ptr + pitch * 8;
        } else {
            p2 = p + 8 * 3;
        }
        for (int j = 0; j < 8; j++) {
            for (int i = 0; i < 8; i++) {
                b = *(p + 3 * i);
                g = *(p + 3 * i + 1);
                r = *(p + 3 * i + 2);
                Y[j * 8 + i] = (int16_t)(0.299 * r + 0.587 * g + 0.114 * b);
                if (k == 0) {
                    U[j * 8 + i] = (int16_t)(-0.16874 * r - 0.33126 * g + 0.5 * b + 128);
                    V[j * 8 + i] = (int16_t)(0.5 * r - 0.41869 * g - 0.08131 * b + 128);
                }
            }
            p += pitch;
        }
        Y += 64;
    }
}

void YUV420_to_BGRA32(uint8_t *ptr, int pitch, uint8_t *yout, uint8_t *uout,
                      uint8_t *vout, int y_stride, int uv_stride, int mbrows,
                      int mbcols) {
    uint8_t *p = ptr, *p2 = ptr;
    int width = mbcols << 4;
    int right_space = pitch - width * 4;
    uint8_t *Y, *U, *V;
    int16_t yy, u, v;
    uint8_t r, g, b;

    for (int y = 0; y < mbrows; y++) {
        for (int x = 0; x < mbcols; x++) {
            Y = yout + (y_stride * y + x) * 16;
            U = uout + 8 * (uv_stride * y + x);
            V = vout + 8 * (uv_stride * y + x);
            p = p2;
            p2 = p + 16 * 4;
            for (int i = 0; i < 16; i++) {
                for (int j = 0; j < 16; j++) {
                    yy = Y[i * y_stride + j];
                    u = U[(i / 2) * uv_stride + (j / 2)] - 128;
                    v = V[(i / 2) * uv_stride + (j / 2)] - 128;
                    // r = clamp(yy + 1.4075 * v, 255);
                    // g = clamp(yy - 0.3455 * u - 0.7169 * v, 255);
                    // b = clamp(yy + 1.779 * u, 255);
                    r = clamp(yy + 1.28 * v, 255);
                    g = clamp(yy - 0.215 * u - 0.381 * v, 255);
                    b = clamp(yy + 2.128 * u, 255);
                    p[4 * j] = b;
                    p[4 * j + 1] = g;
                    p[4 * j + 2] = r;
                    p[4 * j + 3] = 0xFF;
                }
                p += pitch;
            }
        }
        p2 = p - pitch + 16 * 4 + right_space;
    }
}

const float r2yuv_8bit[3][256] = {
    {0.00,  0.30,  0.60,  0.90,  1.20,  1.49,  1.79,  2.09,  2.39,  2.69,
     2.99,  3.29,  3.59,  3.89,  4.19,  4.48,  4.78,  5.08,  5.38,  5.68,
     5.98,  6.28,  6.58,  6.88,  7.18,  7.47,  7.77,  8.07,  8.37,  8.67,
     8.97,  9.27,  9.57,  9.87,  10.17, 10.46, 10.76, 11.06, 11.36, 11.66,
     11.96, 12.26, 12.56, 12.86, 13.16, 13.46, 13.75, 14.05, 14.35, 14.65,
     14.95, 15.25, 15.55, 15.85, 16.15, 16.45, 16.74, 17.04, 17.34, 17.64,
     17.94, 18.24, 18.54, 18.84, 19.14, 19.43, 19.73, 20.03, 20.33, 20.63,
     20.93, 21.23, 21.53, 21.83, 22.13, 22.43, 22.72, 23.02, 23.32, 23.62,
     23.92, 24.22, 24.52, 24.82, 25.12, 25.41, 25.71, 26.01, 26.31, 26.61,
     26.91, 27.21, 27.51, 27.81, 28.11, 28.40, 28.70, 29.00, 29.30, 29.60,
     29.90, 30.20, 30.50, 30.80, 31.10, 31.39, 31.69, 31.99, 32.29, 32.59,
     32.89, 33.19, 33.49, 33.79, 34.09, 34.38, 34.68, 34.98, 35.28, 35.58,
     35.88, 36.18, 36.48, 36.78, 37.08, 37.38, 37.67, 37.97, 38.27, 38.57,
     38.87, 39.17, 39.47, 39.77, 40.07, 40.36, 40.66, 40.96, 41.26, 41.56,
     41.86, 42.16, 42.46, 42.76, 43.06, 43.35, 43.65, 43.95, 44.25, 44.55,
     44.85, 45.15, 45.45, 45.75, 46.05, 46.34, 46.64, 46.94, 47.24, 47.54,
     47.84, 48.14, 48.44, 48.74, 49.04, 49.34, 49.63, 49.93, 50.23, 50.53,
     50.83, 51.13, 51.43, 51.73, 52.03, 52.32, 52.62, 52.92, 53.22, 53.52,
     53.82, 54.12, 54.42, 54.72, 55.02, 55.31, 55.61, 55.91, 56.21, 56.51,
     56.81, 57.11, 57.41, 57.71, 58.01, 58.30, 58.60, 58.90, 59.20, 59.50,
     59.80, 60.10, 60.40, 60.70, 61.00, 61.29, 61.59, 61.89, 62.19, 62.49,
     62.79, 63.09, 63.39, 63.69, 63.99, 64.28, 64.58, 64.88, 65.18, 65.48,
     65.78, 66.08, 66.38, 66.68, 66.98, 67.27, 67.57, 67.87, 68.17, 68.47,
     68.77, 69.07, 69.37, 69.67, 69.97, 70.27, 70.56, 70.86, 71.16, 71.46,
     71.76, 72.06, 72.36, 72.66, 72.96, 73.25, 73.55, 73.85, 74.15, 74.45,
     74.75, 75.05, 75.35, 75.65, 75.95, 76.24},
    {0.00,   -0.17,  -0.34,  -0.51,  -0.67,  -0.84,  -1.01,  -1.18,  -1.35,
     -1.52,  -1.69,  -1.86,  -2.02,  -2.19,  -2.36,  -2.53,  -2.70,  -2.87,
     -3.04,  -3.21,  -3.37,  -3.54,  -3.71,  -3.88,  -4.05,  -4.22,  -4.39,
     -4.55,  -4.72,  -4.89,  -5.06,  -5.23,  -5.40,  -5.57,  -5.74,  -5.90,
     -6.07,  -6.24,  -6.41,  -6.58,  -6.75,  -6.92,  -7.09,  -7.25,  -7.42,
     -7.59,  -7.76,  -7.93,  -8.10,  -8.27,  -8.43,  -8.60,  -8.77,  -8.94,
     -9.11,  -9.28,  -9.45,  -9.62,  -9.78,  -9.95,  -10.12, -10.29, -10.46,
     -10.63, -10.80, -10.97, -11.13, -11.30, -11.47, -11.64, -11.81, -11.98,
     -12.15, -12.32, -12.48, -12.65, -12.82, -12.99, -13.16, -13.33, -13.50,
     -13.66, -13.83, -14.00, -14.17, -14.34, -14.51, -14.68, -14.85, -15.01,
     -15.18, -15.35, -15.52, -15.69, -15.86, -16.03, -16.20, -16.36, -16.53,
     -16.70, -16.87, -17.04, -17.21, -17.38, -17.54, -17.71, -17.88, -18.05,
     -18.22, -18.39, -18.56, -18.73, -18.89, -19.06, -19.23, -19.40, -19.57,
     -19.74, -19.91, -20.08, -20.24, -20.41, -20.58, -20.75, -20.92, -21.09,
     -21.26, -21.42, -21.59, -21.76, -21.93, -22.10, -22.27, -22.44, -22.61,
     -22.77, -22.94, -23.11, -23.28, -23.45, -23.62, -23.79, -23.96, -24.12,
     -24.29, -24.46, -24.63, -24.80, -24.97, -25.14, -25.30, -25.47, -25.64,
     -25.81, -25.98, -26.15, -26.32, -26.49, -26.65, -26.82, -26.99, -27.16,
     -27.33, -27.50, -27.67, -27.84, -28.00, -28.17, -28.34, -28.51, -28.68,
     -28.85, -29.02, -29.19, -29.35, -29.52, -29.69, -29.86, -30.03, -30.20,
     -30.37, -30.53, -30.70, -30.87, -31.04, -31.21, -31.38, -31.55, -31.72,
     -31.88, -32.05, -32.22, -32.39, -32.56, -32.73, -32.90, -33.07, -33.23,
     -33.40, -33.57, -33.74, -33.91, -34.08, -34.25, -34.41, -34.58, -34.75,
     -34.92, -35.09, -35.26, -35.43, -35.60, -35.76, -35.93, -36.10, -36.27,
     -36.44, -36.61, -36.78, -36.95, -37.11, -37.28, -37.45, -37.62, -37.79,
     -37.96, -38.13, -38.29, -38.46, -38.63, -38.80, -38.97, -39.14, -39.31,
     -39.48, -39.64, -39.81, -39.98, -40.15, -40.32, -40.49, -40.66, -40.83,
     -40.99, -41.16, -41.33, -41.50, -41.67, -41.84, -42.01, -42.17, -42.34,
     -42.51, -42.68, -42.85, -43.02},
    {0.00,   0.50,   1.00,   1.50,   2.00,   2.50,   3.00,   3.50,   4.00,
     4.50,   5.00,   5.50,   6.00,   6.50,   7.00,   7.50,   8.00,   8.50,
     9.00,   9.50,   10.00,  10.50,  11.00,  11.50,  12.00,  12.50,  13.00,
     13.50,  14.00,  14.50,  15.00,  15.50,  16.00,  16.50,  17.00,  17.50,
     18.00,  18.50,  19.00,  19.50,  20.00,  20.50,  21.00,  21.50,  22.00,
     22.50,  23.00,  23.50,  24.00,  24.50,  25.00,  25.50,  26.00,  26.50,
     27.00,  27.50,  28.00,  28.50,  29.00,  29.50,  30.00,  30.50,  31.00,
     31.50,  32.00,  32.50,  33.00,  33.50,  34.00,  34.50,  35.00,  35.50,
     36.00,  36.50,  37.00,  37.50,  38.00,  38.50,  39.00,  39.50,  40.00,
     40.50,  41.00,  41.50,  42.00,  42.50,  43.00,  43.50,  44.00,  44.50,
     45.00,  45.50,  46.00,  46.50,  47.00,  47.50,  48.00,  48.50,  49.00,
     49.50,  50.00,  50.50,  51.00,  51.50,  52.00,  52.50,  53.00,  53.50,
     54.00,  54.50,  55.00,  55.50,  56.00,  56.50,  57.00,  57.50,  58.00,
     58.50,  59.00,  59.50,  60.00,  60.50,  61.00,  61.50,  62.00,  62.50,
     63.00,  63.50,  64.00,  64.50,  65.00,  65.50,  66.00,  66.50,  67.00,
     67.50,  68.00,  68.50,  69.00,  69.50,  70.00,  70.50,  71.00,  71.50,
     72.00,  72.50,  73.00,  73.50,  74.00,  74.50,  75.00,  75.50,  76.00,
     76.50,  77.00,  77.50,  78.00,  78.50,  79.00,  79.50,  80.00,  80.50,
     81.00,  81.50,  82.00,  82.50,  83.00,  83.50,  84.00,  84.50,  85.00,
     85.50,  86.00,  86.50,  87.00,  87.50,  88.00,  88.50,  89.00,  89.50,
     90.00,  90.50,  91.00,  91.50,  92.00,  92.50,  93.00,  93.50,  94.00,
     94.50,  95.00,  95.50,  96.00,  96.50,  97.00,  97.50,  98.00,  98.50,
     99.00,  99.50,  100.00, 100.50, 101.00, 101.50, 102.00, 102.50, 103.00,
     103.50, 104.00, 104.50, 105.00, 105.50, 106.00, 106.50, 107.00, 107.50,
     108.00, 108.50, 109.00, 109.50, 110.00, 110.50, 111.00, 111.50, 112.00,
     112.50, 113.00, 113.50, 114.00, 114.50, 115.00, 115.50, 116.00, 116.50,
     117.00, 117.50, 118.00, 118.50, 119.00, 119.50, 120.00, 120.50, 121.00,
     121.50, 122.00, 122.50, 123.00, 123.50, 124.00, 124.50, 125.00, 125.50,
     126.00, 126.50, 127.00, 127.50}};

const float g2yuv_8bit[3][256] = {
    {0.00,   0.59,   1.17,   1.76,   2.35,   2.93,   3.52,   4.11,   4.70,
     5.28,   5.87,   6.46,   7.04,   7.63,   8.22,   8.80,   9.39,   9.98,
     10.57,  11.15,  11.74,  12.33,  12.91,  13.50,  14.09,  14.67,  15.26,
     15.85,  16.44,  17.02,  17.61,  18.20,  18.78,  19.37,  19.96,  20.54,
     21.13,  21.72,  22.31,  22.89,  23.48,  24.07,  24.65,  25.24,  25.83,
     26.41,  27.00,  27.59,  28.18,  28.76,  29.35,  29.94,  30.52,  31.11,
     31.70,  32.28,  32.87,  33.46,  34.05,  34.63,  35.22,  35.81,  36.39,
     36.98,  37.57,  38.16,  38.74,  39.33,  39.92,  40.50,  41.09,  41.68,
     42.26,  42.85,  43.44,  44.02,  44.61,  45.20,  45.79,  46.37,  46.96,
     47.55,  48.13,  48.72,  49.31,  49.89,  50.48,  51.07,  51.66,  52.24,
     52.83,  53.42,  54.00,  54.59,  55.18,  55.76,  56.35,  56.94,  57.53,
     58.11,  58.70,  59.29,  59.87,  60.46,  61.05,  61.63,  62.22,  62.81,
     63.40,  63.98,  64.57,  65.16,  65.74,  66.33,  66.92,  67.50,  68.09,
     68.68,  69.27,  69.85,  70.44,  71.03,  71.61,  72.20,  72.79,  73.38,
     73.96,  74.55,  75.14,  75.72,  76.31,  76.90,  77.48,  78.07,  78.66,
     79.24,  79.83,  80.42,  81.01,  81.59,  82.18,  82.77,  83.35,  83.94,
     84.53,  85.11,  85.70,  86.29,  86.88,  87.46,  88.05,  88.64,  89.22,
     89.81,  90.40,  90.98,  91.57,  92.16,  92.75,  93.33,  93.92,  94.51,
     95.09,  95.68,  96.27,  96.85,  97.44,  98.03,  98.62,  99.20,  99.79,
     100.38, 100.96, 101.55, 102.14, 102.72, 103.31, 103.90, 104.49, 105.07,
     105.66, 106.25, 106.83, 107.42, 108.01, 108.59, 109.18, 109.77, 110.36,
     110.94, 111.53, 112.12, 112.70, 113.29, 113.88, 114.46, 115.05, 115.64,
     116.23, 116.81, 117.40, 117.99, 118.57, 119.16, 119.75, 120.33, 120.92,
     121.51, 122.10, 122.68, 123.27, 123.86, 124.44, 125.03, 125.62, 126.20,
     126.79, 127.38, 127.97, 128.55, 129.14, 129.73, 130.31, 130.90, 131.49,
     132.07, 132.66, 133.25, 133.84, 134.42, 135.01, 135.60, 136.18, 136.77,
     137.36, 137.94, 138.53, 139.12, 139.71, 140.29, 140.88, 141.47, 142.05,
     142.64, 143.23, 143.81, 144.40, 144.99, 145.58, 146.16, 146.75, 147.34,
     147.92, 148.51, 149.10, 149.69},
    {0.00,   -0.33,  -0.66,  -0.99,  -1.33,  -1.66,  -1.99,  -2.32,  -2.65,
     -2.98,  -3.31,  -3.64,  -3.98,  -4.31,  -4.64,  -4.97,  -5.30,  -5.63,
     -5.96,  -6.29,  -6.63,  -6.96,  -7.29,  -7.62,  -7.95,  -8.28,  -8.61,
     -8.95,  -9.28,  -9.61,  -9.94,  -10.27, -10.60, -10.93, -11.26, -11.60,
     -11.93, -12.26, -12.59, -12.92, -13.25, -13.58, -13.91, -14.25, -14.58,
     -14.91, -15.24, -15.57, -15.90, -16.23, -16.56, -16.90, -17.23, -17.56,
     -17.89, -18.22, -18.55, -18.88, -19.22, -19.55, -19.88, -20.21, -20.54,
     -20.87, -21.20, -21.53, -21.87, -22.20, -22.53, -22.86, -23.19, -23.52,
     -23.85, -24.18, -24.52, -24.85, -25.18, -25.51, -25.84, -26.17, -26.50,
     -26.84, -27.17, -27.50, -27.83, -28.16, -28.49, -28.82, -29.15, -29.49,
     -29.82, -30.15, -30.48, -30.81, -31.14, -31.47, -31.80, -32.14, -32.47,
     -32.80, -33.13, -33.46, -33.79, -34.12, -34.46, -34.79, -35.12, -35.45,
     -35.78, -36.11, -36.44, -36.77, -37.11, -37.44, -37.77, -38.10, -38.43,
     -38.76, -39.09, -39.42, -39.76, -40.09, -40.42, -40.75, -41.08, -41.41,
     -41.74, -42.08, -42.41, -42.74, -43.07, -43.40, -43.73, -44.06, -44.39,
     -44.73, -45.06, -45.39, -45.72, -46.05, -46.38, -46.71, -47.04, -47.38,
     -47.71, -48.04, -48.37, -48.70, -49.03, -49.36, -49.70, -50.03, -50.36,
     -50.69, -51.02, -51.35, -51.68, -52.01, -52.35, -52.68, -53.01, -53.34,
     -53.67, -54.00, -54.33, -54.66, -55.00, -55.33, -55.66, -55.99, -56.32,
     -56.65, -56.98, -57.31, -57.65, -57.98, -58.31, -58.64, -58.97, -59.30,
     -59.63, -59.97, -60.30, -60.63, -60.96, -61.29, -61.62, -61.95, -62.28,
     -62.62, -62.95, -63.28, -63.61, -63.94, -64.27, -64.60, -64.93, -65.27,
     -65.60, -65.93, -66.26, -66.59, -66.92, -67.25, -67.59, -67.92, -68.25,
     -68.58, -68.91, -69.24, -69.57, -69.90, -70.24, -70.57, -70.90, -71.23,
     -71.56, -71.89, -72.22, -72.55, -72.89, -73.22, -73.55, -73.88, -74.21,
     -74.54, -74.87, -75.21, -75.54, -75.87, -76.20, -76.53, -76.86, -77.19,
     -77.52, -77.86, -78.19, -78.52, -78.85, -79.18, -79.51, -79.84, -80.17,
     -80.51, -80.84, -81.17, -81.50, -81.83, -82.16, -82.49, -82.83, -83.16,
     -83.49, -83.82, -84.15, -84.48},
    {0.00,    -0.42,   -0.84,   -1.26,   -1.67,   -2.09,   -2.51,   -2.93,
     -3.35,   -3.77,   -4.19,   -4.61,   -5.02,   -5.44,   -5.86,   -6.28,
     -6.70,   -7.12,   -7.54,   -7.96,   -8.37,   -8.79,   -9.21,   -9.63,
     -10.05,  -10.47,  -10.89,  -11.30,  -11.72,  -12.14,  -12.56,  -12.98,
     -13.40,  -13.82,  -14.24,  -14.65,  -15.07,  -15.49,  -15.91,  -16.33,
     -16.75,  -17.17,  -17.59,  -18.00,  -18.42,  -18.84,  -19.26,  -19.68,
     -20.10,  -20.52,  -20.94,  -21.35,  -21.77,  -22.19,  -22.61,  -23.03,
     -23.45,  -23.87,  -24.28,  -24.70,  -25.12,  -25.54,  -25.96,  -26.38,
     -26.80,  -27.22,  -27.63,  -28.05,  -28.47,  -28.89,  -29.31,  -29.73,
     -30.15,  -30.57,  -30.98,  -31.40,  -31.82,  -32.24,  -32.66,  -33.08,
     -33.50,  -33.91,  -34.33,  -34.75,  -35.17,  -35.59,  -36.01,  -36.43,
     -36.85,  -37.26,  -37.68,  -38.10,  -38.52,  -38.94,  -39.36,  -39.78,
     -40.20,  -40.61,  -41.03,  -41.45,  -41.87,  -42.29,  -42.71,  -43.13,
     -43.54,  -43.96,  -44.38,  -44.80,  -45.22,  -45.64,  -46.06,  -46.48,
     -46.89,  -47.31,  -47.73,  -48.15,  -48.57,  -48.99,  -49.41,  -49.83,
     -50.24,  -50.66,  -51.08,  -51.50,  -51.92,  -52.34,  -52.76,  -53.17,
     -53.59,  -54.01,  -54.43,  -54.85,  -55.27,  -55.69,  -56.11,  -56.52,
     -56.94,  -57.36,  -57.78,  -58.20,  -58.62,  -59.04,  -59.46,  -59.87,
     -60.29,  -60.71,  -61.13,  -61.55,  -61.97,  -62.39,  -62.80,  -63.22,
     -63.64,  -64.06,  -64.48,  -64.90,  -65.32,  -65.74,  -66.15,  -66.57,
     -66.99,  -67.41,  -67.83,  -68.25,  -68.67,  -69.09,  -69.50,  -69.92,
     -70.34,  -70.76,  -71.18,  -71.60,  -72.02,  -72.44,  -72.85,  -73.27,
     -73.69,  -74.11,  -74.53,  -74.95,  -75.37,  -75.78,  -76.20,  -76.62,
     -77.04,  -77.46,  -77.88,  -78.30,  -78.72,  -79.13,  -79.55,  -79.97,
     -80.39,  -80.81,  -81.23,  -81.65,  -82.07,  -82.48,  -82.90,  -83.32,
     -83.74,  -84.16,  -84.58,  -85.00,  -85.41,  -85.83,  -86.25,  -86.67,
     -87.09,  -87.51,  -87.93,  -88.35,  -88.76,  -89.18,  -89.60,  -90.02,
     -90.44,  -90.86,  -91.28,  -91.70,  -92.11,  -92.53,  -92.95,  -93.37,
     -93.79,  -94.21,  -94.63,  -95.04,  -95.46,  -95.88,  -96.30,  -96.72,
     -97.14,  -97.56,  -97.98,  -98.39,  -98.81,  -99.23,  -99.65,  -100.07,
     -100.49, -100.91, -101.33, -101.74, -102.16, -102.58, -103.00, -103.42,
     -103.84, -104.26, -104.67, -105.09, -105.51, -105.93, -106.35, -106.77}};

const float b2yuv_8bit[3][256] = {
    {0.00,  0.11,  0.23,  0.34,  0.46,  0.57,  0.68,  0.80,  0.91,  1.03,
     1.14,  1.25,  1.37,  1.48,  1.60,  1.71,  1.82,  1.94,  2.05,  2.17,
     2.28,  2.39,  2.51,  2.62,  2.74,  2.85,  2.96,  3.08,  3.19,  3.31,
     3.42,  3.53,  3.65,  3.76,  3.88,  3.99,  4.10,  4.22,  4.33,  4.45,
     4.56,  4.67,  4.79,  4.90,  5.02,  5.13,  5.24,  5.36,  5.47,  5.59,
     5.70,  5.81,  5.93,  6.04,  6.16,  6.27,  6.38,  6.50,  6.61,  6.73,
     6.84,  6.95,  7.07,  7.18,  7.30,  7.41,  7.52,  7.64,  7.75,  7.87,
     7.98,  8.09,  8.21,  8.32,  8.44,  8.55,  8.66,  8.78,  8.89,  9.01,
     9.12,  9.23,  9.35,  9.46,  9.58,  9.69,  9.80,  9.92,  10.03, 10.15,
     10.26, 10.37, 10.49, 10.60, 10.72, 10.83, 10.94, 11.06, 11.17, 11.29,
     11.40, 11.51, 11.63, 11.74, 11.86, 11.97, 12.08, 12.20, 12.31, 12.43,
     12.54, 12.65, 12.77, 12.88, 13.00, 13.11, 13.22, 13.34, 13.45, 13.57,
     13.68, 13.79, 13.91, 14.02, 14.14, 14.25, 14.36, 14.48, 14.59, 14.71,
     14.82, 14.93, 15.05, 15.16, 15.28, 15.39, 15.50, 15.62, 15.73, 15.85,
     15.96, 16.07, 16.19, 16.30, 16.42, 16.53, 16.64, 16.76, 16.87, 16.99,
     17.10, 17.21, 17.33, 17.44, 17.56, 17.67, 17.78, 17.90, 18.01, 18.13,
     18.24, 18.35, 18.47, 18.58, 18.70, 18.81, 18.92, 19.04, 19.15, 19.27,
     19.38, 19.49, 19.61, 19.72, 19.84, 19.95, 20.06, 20.18, 20.29, 20.41,
     20.52, 20.63, 20.75, 20.86, 20.98, 21.09, 21.20, 21.32, 21.43, 21.55,
     21.66, 21.77, 21.89, 22.00, 22.12, 22.23, 22.34, 22.46, 22.57, 22.69,
     22.80, 22.91, 23.03, 23.14, 23.26, 23.37, 23.48, 23.60, 23.71, 23.83,
     23.94, 24.05, 24.17, 24.28, 24.40, 24.51, 24.62, 24.74, 24.85, 24.97,
     25.08, 25.19, 25.31, 25.42, 25.54, 25.65, 25.76, 25.88, 25.99, 26.11,
     26.22, 26.33, 26.45, 26.56, 26.68, 26.79, 26.90, 27.02, 27.13, 27.25,
     27.36, 27.47, 27.59, 27.70, 27.82, 27.93, 28.04, 28.16, 28.27, 28.39,
     28.50, 28.61, 28.73, 28.84, 28.96, 29.07},
    {0.00,   0.50,   1.00,   1.50,   2.00,   2.50,   3.00,   3.50,   4.00,
     4.50,   5.00,   5.50,   6.00,   6.50,   7.00,   7.50,   8.00,   8.50,
     9.00,   9.50,   10.00,  10.50,  11.00,  11.50,  12.00,  12.50,  13.00,
     13.50,  14.00,  14.50,  15.00,  15.50,  16.00,  16.50,  17.00,  17.50,
     18.00,  18.50,  19.00,  19.50,  20.00,  20.50,  21.00,  21.50,  22.00,
     22.50,  23.00,  23.50,  24.00,  24.50,  25.00,  25.50,  26.00,  26.50,
     27.00,  27.50,  28.00,  28.50,  29.00,  29.50,  30.00,  30.50,  31.00,
     31.50,  32.00,  32.50,  33.00,  33.50,  34.00,  34.50,  35.00,  35.50,
     36.00,  36.50,  37.00,  37.50,  38.00,  38.50,  39.00,  39.50,  40.00,
     40.50,  41.00,  41.50,  42.00,  42.50,  43.00,  43.50,  44.00,  44.50,
     45.00,  45.50,  46.00,  46.50,  47.00,  47.50,  48.00,  48.50,  49.00,
     49.50,  50.00,  50.50,  51.00,  51.50,  52.00,  52.50,  53.00,  53.50,
     54.00,  54.50,  55.00,  55.50,  56.00,  56.50,  57.00,  57.50,  58.00,
     58.50,  59.00,  59.50,  60.00,  60.50,  61.00,  61.50,  62.00,  62.50,
     63.00,  63.50,  64.00,  64.50,  65.00,  65.50,  66.00,  66.50,  67.00,
     67.50,  68.00,  68.50,  69.00,  69.50,  70.00,  70.50,  71.00,  71.50,
     72.00,  72.50,  73.00,  73.50,  74.00,  74.50,  75.00,  75.50,  76.00,
     76.50,  77.00,  77.50,  78.00,  78.50,  79.00,  79.50,  80.00,  80.50,
     81.00,  81.50,  82.00,  82.50,  83.00,  83.50,  84.00,  84.50,  85.00,
     85.50,  86.00,  86.50,  87.00,  87.50,  88.00,  88.50,  89.00,  89.50,
     90.00,  90.50,  91.00,  91.50,  92.00,  92.50,  93.00,  93.50,  94.00,
     94.50,  95.00,  95.50,  96.00,  96.50,  97.00,  97.50,  98.00,  98.50,
     99.00,  99.50,  100.00, 100.50, 101.00, 101.50, 102.00, 102.50, 103.00,
     103.50, 104.00, 104.50, 105.00, 105.50, 106.00, 106.50, 107.00, 107.50,
     108.00, 108.50, 109.00, 109.50, 110.00, 110.50, 111.00, 111.50, 112.00,
     112.50, 113.00, 113.50, 114.00, 114.50, 115.00, 115.50, 116.00, 116.50,
     117.00, 117.50, 118.00, 118.50, 119.00, 119.50, 120.00, 120.50, 121.00,
     121.50, 122.00, 122.50, 123.00, 123.50, 124.00, 124.50, 125.00, 125.50,
     126.00, 126.50, 127.00, 127.50},
    {0.00,   -0.08,  -0.16,  -0.24,  -0.33,  -0.41,  -0.49,  -0.57,  -0.65,
     -0.73,  -0.81,  -0.89,  -0.98,  -1.06,  -1.14,  -1.22,  -1.30,  -1.38,
     -1.46,  -1.54,  -1.63,  -1.71,  -1.79,  -1.87,  -1.95,  -2.03,  -2.11,
     -2.20,  -2.28,  -2.36,  -2.44,  -2.52,  -2.60,  -2.68,  -2.76,  -2.85,
     -2.93,  -3.01,  -3.09,  -3.17,  -3.25,  -3.33,  -3.41,  -3.50,  -3.58,
     -3.66,  -3.74,  -3.82,  -3.90,  -3.98,  -4.06,  -4.15,  -4.23,  -4.31,
     -4.39,  -4.47,  -4.55,  -4.63,  -4.72,  -4.80,  -4.88,  -4.96,  -5.04,
     -5.12,  -5.20,  -5.28,  -5.37,  -5.45,  -5.53,  -5.61,  -5.69,  -5.77,
     -5.85,  -5.93,  -6.02,  -6.10,  -6.18,  -6.26,  -6.34,  -6.42,  -6.50,
     -6.59,  -6.67,  -6.75,  -6.83,  -6.91,  -6.99,  -7.07,  -7.15,  -7.24,
     -7.32,  -7.40,  -7.48,  -7.56,  -7.64,  -7.72,  -7.80,  -7.89,  -7.97,
     -8.05,  -8.13,  -8.21,  -8.29,  -8.37,  -8.46,  -8.54,  -8.62,  -8.70,
     -8.78,  -8.86,  -8.94,  -9.02,  -9.11,  -9.19,  -9.27,  -9.35,  -9.43,
     -9.51,  -9.59,  -9.67,  -9.76,  -9.84,  -9.92,  -10.00, -10.08, -10.16,
     -10.24, -10.33, -10.41, -10.49, -10.57, -10.65, -10.73, -10.81, -10.89,
     -10.98, -11.06, -11.14, -11.22, -11.30, -11.38, -11.46, -11.54, -11.63,
     -11.71, -11.79, -11.87, -11.95, -12.03, -12.11, -12.20, -12.28, -12.36,
     -12.44, -12.52, -12.60, -12.68, -12.76, -12.85, -12.93, -13.01, -13.09,
     -13.17, -13.25, -13.33, -13.41, -13.50, -13.58, -13.66, -13.74, -13.82,
     -13.90, -13.98, -14.06, -14.15, -14.23, -14.31, -14.39, -14.47, -14.55,
     -14.63, -14.72, -14.80, -14.88, -14.96, -15.04, -15.12, -15.20, -15.28,
     -15.37, -15.45, -15.53, -15.61, -15.69, -15.77, -15.85, -15.93, -16.02,
     -16.10, -16.18, -16.26, -16.34, -16.42, -16.50, -16.59, -16.67, -16.75,
     -16.83, -16.91, -16.99, -17.07, -17.15, -17.24, -17.32, -17.40, -17.48,
     -17.56, -17.64, -17.72, -17.80, -17.89, -17.97, -18.05, -18.13, -18.21,
     -18.29, -18.37, -18.46, -18.54, -18.62, -18.70, -18.78, -18.86, -18.94,
     -19.02, -19.11, -19.19, -19.27, -19.35, -19.43, -19.51, -19.59, -19.67,
     -19.76, -19.84, -19.92, -20.00, -20.08, -20.16, -20.24, -20.32, -20.41,
     -20.49, -20.57, -20.65, -20.73}
};

void BGRA32_to_YUV420(uint8_t *ptr, int pitch, int16_t *Y, int16_t *U,
                      int16_t *V) {
    int r, g, b;
    uint8_t *p = ptr;
    uint8_t *p2 = ptr;
    for (int k = 0; k < 4; k++) {
        p = p2;
        if (k == 1) {
            p2 = ptr + pitch * 8;
        } else {
            p2 = p + 32;
        }
        for (int j = 0; j < 8; j++) {
            for (int i = 0; i < 8; i++) {
                b = *(p + 4 * i);
                g = *(p + 4 * i + 1);
                r = *(p + 4 * i + 2);
                // Y[j * 8 + i] = 0.299 * r + 0.587 * g + 0.114 * b;
                Y[j * 8 + i] = r2yuv_8bit[0][r] + g2yuv_8bit[0][g] + b2yuv_8bit[0][b];
                if (k == 0) {
                    // U[j * 8 + i] = -0.1687 * r - 0.3313 * g + 0.5 * b + 128;
                    // V[j * 8 + i] = 0.5 * r - 0.4187 * g - 0.0813 * b + 128;
                    U[j * 8 + i] = r2yuv_8bit[1][r] + g2yuv_8bit[1][g] + b2yuv_8bit[1][b] + 128;
                    V[j * 8 + i] = r2yuv_8bit[2][r] + g2yuv_8bit[2][g] + b2yuv_8bit[2][b] + 128;
                }
            }
            p += pitch;
        }
        Y += 64;
    }
}

void YUV420_to_BGRA32_16bit(uint8_t *ptr, int pitch, int16_t *yout, int16_t *uout,
                      int16_t *vout, int y_stride, int uv_stride, int mbrows,
                      int mbcols, int ctbsize) {
    uint8_t *p = ptr, *p2 = ptr;
    int width = mbcols * ctbsize;
    int right_space = pitch - width * 4;
    int16_t *Y, *U, *V;
    int16_t yy, u, v;
    uint8_t r, g, b;

    for (int y = 0; y < mbrows; y++) {
        for (int x = 0; x < mbcols; x++) {
            Y = yout + y_stride * y * ctbsize + x * ctbsize;
            U = uout + ctbsize / 2 * uv_stride * y + x * ctbsize/2;
            V = vout + ctbsize / 2 * uv_stride * y + x * ctbsize/2;
            p = p2;
            p2 = p + ctbsize * 4;
            for (int i = 0; i < ctbsize; i++) {
                for (int j = 0; j < ctbsize; j++) {
                    yy = Y[i * y_stride + j];
                    u = U[(i / 2) * uv_stride + (j / 2)] - 128;
                    v = V[(i / 2) * uv_stride + (j / 2)] - 128;
                    // r = clamp(yy + 1.4075 * v, 255);
                    // g = clamp(yy - 0.3455 * u - 0.7169 * v, 255);
                    // b = clamp(yy + 1.779 * u, 255);
                    r = clamp(yy + 1.280 * v, 255);
                    g = clamp(yy - 0.215 * u - 0.381 * v, 255);
                    b = clamp(yy + 2.128 * u, 255);
                    // r = clamp(yy + v2r_8bit[v], 255);
                    // g = clamp(yy + u2g_8bit[u] + v2g_8bit[v], 255);
                    // b = clamp(yy + u2b_8bit[u], 255);
                    p[4 * j] = b;
                    p[4 * j + 1] = g;
                    p[4 * j + 2] = r;
                    p[4 * j + 3] = 0xFF;
                }
                p += pitch;
            }
        }
        p2 = p - pitch + ctbsize * 4 + right_space;
    }
}

void YUV420_to_BGRA32_8bit(uint8_t *ptr, int pitch, uint8_t *yout,
                           uint8_t *uout, uint8_t *vout, int y_stride,
                           int uv_stride, int mbrows, int mbcols, int ctbsize) {
    uint8_t *p = ptr, *p2 = ptr;
    int width = mbcols * ctbsize;
    int right_space = pitch - width * 4;
    uint8_t *Y, *U, *V;
    uint8_t yy, u, v;
    uint8_t r, g, b;

    for (int y = 0; y < mbrows; y++) {
        for (int x = 0; x < mbcols; x++) {
            Y = yout + y_stride * y * ctbsize + x * ctbsize;
            U = uout + ctbsize / 2 * uv_stride * y + x * ctbsize / 2;
            V = vout + ctbsize / 2 * uv_stride * y + x * ctbsize / 2;
            p = p2;
            p2 = p + ctbsize * 4;
            for (int i = 0; i < ctbsize; i++) {
                for (int j = 0; j < ctbsize; j++) {
                    yy = Y[i * y_stride + j];
                    u = U[(i / 2) * uv_stride + (j / 2)] - 128;
                    v = V[(i / 2) * uv_stride + (j / 2)] - 128;
                    // r = clamp(yy + 1.4075 * v, 255);
                    // g = clamp(yy - 0.3455 * u - 0.7169 * v, 255);
                    // b = clamp(yy + 1.779 * u, 255);
                    // r = clamp(yy + 1.280 * v, 255);
                    // g = clamp(yy - 0.215 * u - 0.381 * v, 255);
                    // b = clamp(yy + 2.128 * u, 255);

                    r = clamp(yy + v2r_8bit[v], 255);
                    g = clamp(yy + u2g_8bit[u] + v2g_8bit[v], 255);
                    b = clamp(yy + u2b_8bit[u], 255);
                    p[4 * j] = b;
                    p[4 * j + 1] = g;
                    p[4 * j + 2] = r;
                    p[4 * j + 3] = 0xFF;
                }
                p += pitch;
            }
        }
        p2 = p - pitch + ctbsize * 4 + right_space;
    }
}

enum cs_bits_type {
  CS_BITLEN_8 = 0,
  CS_BITLEN_16 = 1,

  CS_BITLEN_MAX,
};

static const struct cs_ops cops[CS_BITLEN_MAX] = {
    {
        .YUV_to_BGRA32 = YUV_to_BGRA32_8bit,
    },
    {
        .YUV_to_BGRA32 = YUV_to_BGRA32_16bit,
    },
};

const struct cs_ops *get_cs_ops(int component_bits)
{
    return &cops[(component_bits - 1) / 8];
}

uint32_t CS_MasksToPixelFormatEnum(int bpp, uint32_t rmask, uint32_t gmask,
                                    uint32_t bmask, uint32_t amask) {
    switch (bpp) {
    case 1:
        /* SDL defaults to MSB ordering */
        return CS_PIXELFORMAT_INDEX1MSB;
    case 4:
        /* SDL defaults to MSB ordering */
        return CS_PIXELFORMAT_INDEX4MSB;
    case 8:
        if (rmask == 0) {
            return CS_PIXELFORMAT_INDEX8;
        }
        if (rmask == 0xE0 && gmask == 0x1C && bmask == 0x03 && amask == 0x00) {
            return CS_PIXELFORMAT_RGB332;
        }
        break;
    case 12:
        if (rmask == 0) {
            return CS_PIXELFORMAT_RGB444;
        }
        if (rmask == 0x0F00 && gmask == 0x00F0 && bmask == 0x000F &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_RGB444;
        }
        if (rmask == 0x000F && gmask == 0x00F0 && bmask == 0x0F00 &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_BGR444;
        }
        break;
    case 15:
        if (rmask == 0) {
            return CS_PIXELFORMAT_RGB555;
        }
    /* fallthrough */
    case 16:
        if (rmask == 0) {
            return CS_PIXELFORMAT_RGB565;
        }
        if (rmask == 0x7C00 && gmask == 0x03E0 && bmask == 0x001F &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_RGB555;
        }
        if (rmask == 0x001F && gmask == 0x03E0 && bmask == 0x7C00 &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_BGR555;
        }
        if (rmask == 0x0F00 && gmask == 0x00F0 && bmask == 0x000F &&
            amask == 0xF000) {
            return CS_PIXELFORMAT_ARGB4444;
        }
        if (rmask == 0xF000 && gmask == 0x0F00 && bmask == 0x00F0 &&
            amask == 0x000F) {
            return CS_PIXELFORMAT_RGBA4444;
        }
        if (rmask == 0x000F && gmask == 0x00F0 && bmask == 0x0F00 &&
            amask == 0xF000) {
            return CS_PIXELFORMAT_ABGR4444;
        }
        if (rmask == 0x00F0 && gmask == 0x0F00 && bmask == 0xF000 &&
            amask == 0x000F) {
            return CS_PIXELFORMAT_BGRA4444;
        }
        if (rmask == 0x7C00 && gmask == 0x03E0 && bmask == 0x001F &&
            amask == 0x8000) {
            return CS_PIXELFORMAT_ARGB1555;
        }
        if (rmask == 0xF800 && gmask == 0x07C0 && bmask == 0x003E &&
            amask == 0x0001) {
            return CS_PIXELFORMAT_RGBA5551;
        }
        if (rmask == 0x001F && gmask == 0x03E0 && bmask == 0x7C00 &&
            amask == 0x8000) {
            return CS_PIXELFORMAT_ABGR1555;
        }
        if (rmask == 0x003E && gmask == 0x07C0 && bmask == 0xF800 &&
            amask == 0x0001) {
            return CS_PIXELFORMAT_BGRA5551;
        }
        if (rmask == 0xF800 && gmask == 0x07E0 && bmask == 0x001F &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_RGB565;
        }
        if (rmask == 0x001F && gmask == 0x07E0 && bmask == 0xF800 &&
            amask == 0x0000) {
            return CS_PIXELFORMAT_BGR565;
        }
        if (rmask == 0x003F && gmask == 0x07C0 && bmask == 0xF800 &&
            amask == 0x0000) {
            /* Technically this would be BGR556, but Witek says this works in
             * bug 3158 */
            return CS_PIXELFORMAT_RGB565;
        }
        break;
    case 24:
        switch (rmask) {
        case 0:
        case 0x00FF0000:
#if CS_BYTEORDER == CS_BIG_ENDIAN
            return CS_PIXELFORMAT_RGB24;
#else
            return CS_PIXELFORMAT_BGR24;
#endif
        case 0x000000FF:
#if CS_BYTEORDER == CS_BIG_ENDIAN
            return CS_PIXELFORMAT_BGR24;
#else
            return CS_PIXELFORMAT_RGB24;
#endif
        }
    case 32:
        if (rmask == 0) {
            return CS_PIXELFORMAT_RGB888;
        }
        if (rmask == 0x00FF0000 && gmask == 0x0000FF00 && bmask == 0x000000FF &&
            amask == 0x00000000) {
            return CS_PIXELFORMAT_RGB888;
        }
        if (rmask == 0xFF000000 && gmask == 0x00FF0000 && bmask == 0x0000FF00 &&
            amask == 0x00000000) {
            return CS_PIXELFORMAT_RGBX8888;
        }
        if (rmask == 0x000000FF && gmask == 0x0000FF00 && bmask == 0x00FF0000 &&
            amask == 0x00000000) {
            return CS_PIXELFORMAT_BGR888;
        }
        if (rmask == 0x0000FF00 && gmask == 0x00FF0000 && bmask == 0xFF000000 &&
            amask == 0x00000000) {
            return CS_PIXELFORMAT_BGRX8888;
        }
        if (rmask == 0x00FF0000 && gmask == 0x0000FF00 && bmask == 0x000000FF &&
            amask == 0xFF000000) {
            return CS_PIXELFORMAT_ARGB8888;
        }
        if (rmask == 0xFF000000 && gmask == 0x00FF0000 && bmask == 0x0000FF00 &&
            amask == 0x000000FF) {
            return CS_PIXELFORMAT_RGBA8888;
        }
        if (rmask == 0x000000FF && gmask == 0x0000FF00 && bmask == 0x00FF0000 &&
            amask == 0xFF000000) {
            return CS_PIXELFORMAT_ABGR8888;
        }
        if (rmask == 0x0000FF00 && gmask == 0x00FF0000 && bmask == 0xFF000000 &&
            amask == 0x000000FF) {
            return CS_PIXELFORMAT_BGRA8888;
        }
        if (rmask == 0x3FF00000 && gmask == 0x000FFC00 && bmask == 0x000003FF &&
            amask == 0xC0000000) {
            return CS_PIXELFORMAT_ARGB2101010;
        }
    }
    return CS_PIXELFORMAT_UNKNOWN;
}

const char *CS_GetPixelFormatName(uint32_t format) {
    switch (format) {
#define CASE(X)                                                                \
  case X:                                                                      \
    return #X;
        CASE(CS_PIXELFORMAT_INDEX1LSB)
        CASE(CS_PIXELFORMAT_INDEX1MSB)
        CASE(CS_PIXELFORMAT_INDEX4LSB)
        CASE(CS_PIXELFORMAT_INDEX4MSB)
        CASE(CS_PIXELFORMAT_INDEX8)
        CASE(CS_PIXELFORMAT_RGB332)
        CASE(CS_PIXELFORMAT_RGB444)
        CASE(CS_PIXELFORMAT_BGR444)
        CASE(CS_PIXELFORMAT_RGB555)
        CASE(CS_PIXELFORMAT_BGR555)
        CASE(CS_PIXELFORMAT_ARGB4444)
        CASE(CS_PIXELFORMAT_RGBA4444)
        CASE(CS_PIXELFORMAT_ABGR4444)
        CASE(CS_PIXELFORMAT_BGRA4444)
        CASE(CS_PIXELFORMAT_ARGB1555)
        CASE(CS_PIXELFORMAT_RGBA5551)
        CASE(CS_PIXELFORMAT_ABGR1555)
        CASE(CS_PIXELFORMAT_BGRA5551)
        CASE(CS_PIXELFORMAT_RGB565)
        CASE(CS_PIXELFORMAT_BGR565)
        CASE(CS_PIXELFORMAT_RGB24)
        CASE(CS_PIXELFORMAT_BGR24)
        CASE(CS_PIXELFORMAT_RGB888)
        CASE(CS_PIXELFORMAT_RGBX8888)
        CASE(CS_PIXELFORMAT_BGR888)
        CASE(CS_PIXELFORMAT_BGRX8888)
        CASE(CS_PIXELFORMAT_ARGB8888)
        CASE(CS_PIXELFORMAT_RGBA8888)
        CASE(CS_PIXELFORMAT_ABGR8888)
        CASE(CS_PIXELFORMAT_BGRA8888)
        CASE(CS_PIXELFORMAT_ARGB2101010)
        CASE(CS_PIXELFORMAT_YV12)
        CASE(CS_PIXELFORMAT_IYUV)
        CASE(CS_PIXELFORMAT_YUY2)
        CASE(CS_PIXELFORMAT_UYVY)
        CASE(CS_PIXELFORMAT_YVYU)
        CASE(CS_PIXELFORMAT_NV12)
        CASE(CS_PIXELFORMAT_NV21)
#undef CASE
    default:
        return "CS_PIXELFORMAT_UNKNOWN";
    }
}


// Hue/Saturation/Value
void BGRA32_TO_HSV(uint8_t *ptr, int pitch, int height, uint16_t* h, uint8_t *s, uint8_t *v)
{
    for (int y = 0; y < height; y++) {
        for (int x = 0; x < pitch; x += 4) {
            uint8_t b = ptr[x + y * pitch];
            uint8_t g = ptr[x + 1 + y * pitch];
            uint8_t r = ptr[x + 2 + y * pitch];
            uint8_t cmax = MAX(MAX(b, g), r);
            uint8_t cmin = MIN(MIN(b, g), r);
            if (cmax == cmin) {
                *h = 0;
            } else if (cmax == r) {
                if (g >= b) {
                    *h = 60 * (g - b)/(cmax - cmin);
                } else {
                    *h = 60 * (g - b) / (cmax - cmin) + 360;
                }
            } else if (cmax == g) {
                *h = 60 * (b - r) / (cmax - cmin) + 120;
            } else if (cmax == b) {
                *h = 60 * (r - g) / (cmax - cmin) + 240;
            }
            h++;
            *s++ = (cmax == 0) ? 0 : 255 - 255 * cmin/cmax;
            *v++ = cmax;
        }
    }
}
